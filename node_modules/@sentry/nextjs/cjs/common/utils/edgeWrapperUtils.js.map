{"version":3,"file":"edgeWrapperUtils.js","sources":["../../../../src/common/utils/edgeWrapperUtils.ts"],"sourcesContent":["import {\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  addTracingExtensions,\n  captureException,\n  continueTrace,\n  handleCallbackErrors,\n  setHttpStatus,\n  startSpan,\n} from '@sentry/core';\nimport { winterCGRequestToRequestData } from '@sentry/utils';\n\nimport type { EdgeRouteHandler } from '../../edge/types';\nimport { flushQueue } from './responseEnd';\n\n/**\n * Wraps a function on the edge runtime with error and performance monitoring.\n */\nexport function withEdgeWrapping<H extends EdgeRouteHandler>(\n  handler: H,\n  options: { spanDescription: string; spanOp: string; mechanismFunctionName: string },\n): (...params: Parameters<H>) => Promise<ReturnType<H>> {\n  return async function (this: unknown, ...args) {\n    addTracingExtensions();\n    const req: unknown = args[0];\n\n    let sentryTrace;\n    let baggage;\n\n    if (req instanceof Request) {\n      sentryTrace = req.headers.get('sentry-trace') || '';\n      baggage = req.headers.get('baggage');\n    }\n\n    return continueTrace(\n      {\n        sentryTrace,\n        baggage,\n      },\n      () => {\n        return startSpan(\n          {\n            name: options.spanDescription,\n            op: options.spanOp,\n            attributes: {\n              [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'route',\n              [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.function.nextjs.withEdgeWrapping',\n            },\n            metadata: {\n              request: req instanceof Request ? winterCGRequestToRequestData(req) : undefined,\n            },\n          },\n          async span => {\n            const handlerResult = await handleCallbackErrors(\n              () => handler.apply(this, args),\n              error => {\n                captureException(error, {\n                  mechanism: {\n                    type: 'instrument',\n                    handled: false,\n                    data: {\n                      function: options.mechanismFunctionName,\n                    },\n                  },\n                });\n              },\n            );\n\n            if (span) {\n              if (handlerResult instanceof Response) {\n                setHttpStatus(span, handlerResult.status);\n              } else {\n                span.setStatus('ok');\n              }\n            }\n\n            return handlerResult;\n          },\n        ).finally(() => flushQueue());\n      },\n    );\n  };\n}\n"],"names":["addTracingExtensions","continueTrace","startSpan","SEMANTIC_ATTRIBUTE_SENTRY_SOURCE","SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN","winterCGRequestToRequestData","handleCallbackErrors","captureException","setHttpStatus","flushQueue"],"mappings":";;;;;;AAeA;AACA;AACA;AACO,SAAS,gBAAgB;AAChC,EAAE,OAAO;AACT,EAAE,OAAO;AACT,EAAwD;AACxD,EAAE,OAAO,iBAA+B,GAAG,IAAI,EAAE;AACjD,IAAIA,yBAAoB,EAAE,CAAA;AAC1B,IAAI,MAAM,GAAG,GAAY,IAAI,CAAC,CAAC,CAAC,CAAA;AAChC;AACA,IAAI,IAAI,WAAW,CAAA;AACnB,IAAI,IAAI,OAAO,CAAA;AACf;AACA,IAAI,IAAI,GAAI,YAAW,OAAO,EAAE;AAChC,MAAM,WAAA,GAAc,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAE,IAAG,EAAE,CAAA;AACzD,MAAM,OAAA,GAAU,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAA;AAC1C,KAAI;AACJ;AACA,IAAI,OAAOC,kBAAa;AACxB,MAAM;AACN,QAAQ,WAAW;AACnB,QAAQ,OAAO;AACf,OAAO;AACP,MAAM,MAAM;AACZ,QAAQ,OAAOC,cAAS;AACxB,UAAU;AACV,YAAY,IAAI,EAAE,OAAO,CAAC,eAAe;AACzC,YAAY,EAAE,EAAE,OAAO,CAAC,MAAM;AAC9B,YAAY,UAAU,EAAE;AACxB,cAAc,CAACC,qCAAgC,GAAG,OAAO;AACzD,cAAc,CAACC,qCAAgC,GAAG,uCAAuC;AACzF,aAAa;AACb,YAAY,QAAQ,EAAE;AACtB,cAAc,OAAO,EAAE,GAAA,YAAe,OAAA,GAAUC,kCAA4B,CAAC,GAAG,CAAE,GAAE,SAAS;AAC7F,aAAa;AACb,WAAW;AACX,UAAU,MAAM,QAAQ;AACxB,YAAY,MAAM,aAAA,GAAgB,MAAMC,yBAAoB;AAC5D,cAAc,MAAM,OAAO,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC;AAC7C,cAAc,SAAS;AACvB,gBAAgBC,qBAAgB,CAAC,KAAK,EAAE;AACxC,kBAAkB,SAAS,EAAE;AAC7B,oBAAoB,IAAI,EAAE,YAAY;AACtC,oBAAoB,OAAO,EAAE,KAAK;AAClC,oBAAoB,IAAI,EAAE;AAC1B,sBAAsB,QAAQ,EAAE,OAAO,CAAC,qBAAqB;AAC7D,qBAAqB;AACrB,mBAAmB;AACnB,iBAAiB,CAAC,CAAA;AAClB,eAAe;AACf,aAAa,CAAA;AACb;AACA,YAAY,IAAI,IAAI,EAAE;AACtB,cAAc,IAAI,aAAc,YAAW,QAAQ,EAAE;AACrD,gBAAgBC,kBAAa,CAAC,IAAI,EAAE,aAAa,CAAC,MAAM,CAAC,CAAA;AACzD,qBAAqB;AACrB,gBAAgB,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAA;AACpC,eAAc;AACd,aAAY;AACZ;AACA,YAAY,OAAO,aAAa,CAAA;AAChC,WAAW;AACX,SAAS,CAAC,OAAO,CAAC,MAAMC,sBAAU,EAAE,CAAC,CAAA;AACrC,OAAO;AACP,KAAK,CAAA;AACL,GAAG,CAAA;AACH;;;;"}