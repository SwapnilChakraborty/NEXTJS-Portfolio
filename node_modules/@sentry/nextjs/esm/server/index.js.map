{"version":3,"file":"index.js","sources":["../../../src/server/index.ts"],"sourcesContent":["import { addTracingExtensions, applySdkMetadata, getClient } from '@sentry/core';\nimport type { NodeOptions } from '@sentry/node';\nimport {\n  Integrations as OriginalIntegrations,\n  getCurrentScope,\n  getDefaultIntegrations,\n  init as nodeInit,\n} from '@sentry/node';\nimport type { EventProcessor } from '@sentry/types';\nimport { logger } from '@sentry/utils';\n\nimport { DEBUG_BUILD } from '../common/debug-build';\nimport { devErrorSymbolicationEventProcessor } from '../common/devErrorSymbolicationEventProcessor';\nimport { getVercelEnv } from '../common/getVercelEnv';\nimport { isBuild } from '../common/utils/isBuild';\nimport { Http } from './httpIntegration';\nimport { OnUncaughtException } from './onUncaughtExceptionIntegration';\nimport { rewriteFramesIntegration } from './rewriteFramesIntegration';\n\nexport { createReduxEnhancer } from '@sentry/react';\nexport * from '@sentry/node';\nexport { captureUnderscoreErrorException } from '../common/_error';\n\nexport const Integrations = {\n  ...OriginalIntegrations,\n  Http,\n  OnUncaughtException,\n};\n\nexport { rewriteFramesIntegration };\n\n/**\n * A passthrough error boundary for the server that doesn't depend on any react. Error boundaries don't catch SSR errors\n * so they should simply be a passthrough.\n */\nexport const ErrorBoundary = (props: React.PropsWithChildren<unknown>): React.ReactNode => {\n  if (!props.children) {\n    return null;\n  }\n\n  if (typeof props.children === 'function') {\n    return (props.children as () => React.ReactNode)();\n  }\n\n  // since Next.js >= 10 requires React ^16.6.0 we are allowed to return children like this here\n  return props.children as React.ReactNode;\n};\n\n/**\n * A passthrough error boundary wrapper for the server that doesn't depend on any react. Error boundaries don't catch\n * SSR errors so they should simply be a passthrough.\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function withErrorBoundary<P extends Record<string, any>>(\n  WrappedComponent: React.ComponentType<P>,\n): React.FC<P> {\n  return WrappedComponent as React.FC<P>;\n}\n\n/**\n * Just a passthrough since we're on the server and showing the report dialog on the server doesn't make any sense.\n */\nexport function showReportDialog(): void {\n  return;\n}\n\n// TODO (v8): Remove this\n/**\n * @deprecated This constant will be removed in the next major update.\n */\nexport const IS_BUILD = isBuild();\n\nconst IS_VERCEL = !!process.env.VERCEL;\n\n/** Inits the Sentry NextJS SDK on node. */\nexport function init(options: NodeOptions): void {\n  addTracingExtensions();\n\n  if (isBuild()) {\n    return;\n  }\n\n  const customDefaultIntegrations = [\n    ...getDefaultIntegrations(options).filter(\n      integration => !['Http', 'OnUncaughtException'].includes(integration.name),\n    ),\n    rewriteFramesIntegration(),\n    new Http(),\n    new OnUncaughtException(),\n  ];\n\n  const opts = {\n    environment: process.env.SENTRY_ENVIRONMENT || getVercelEnv(false) || process.env.NODE_ENV,\n    defaultIntegrations: customDefaultIntegrations,\n    ...options,\n    // Right now we only capture frontend sessions for Next.js\n    autoSessionTracking: false,\n  };\n\n  if (DEBUG_BUILD && opts.debug) {\n    logger.enable();\n  }\n\n  DEBUG_BUILD && logger.log('Initializing SDK...');\n\n  if (sdkAlreadyInitialized()) {\n    DEBUG_BUILD && logger.log('SDK already initialized');\n    return;\n  }\n\n  applySdkMetadata(opts, 'nextjs', ['nextjs', 'node']);\n\n  nodeInit(opts);\n\n  const filterTransactions: EventProcessor = event => {\n    return event.type === 'transaction' && event.transaction === '/404' ? null : event;\n  };\n\n  filterTransactions.id = 'NextServer404TransactionFilter';\n\n  const scope = getCurrentScope();\n  scope.setTag('runtime', 'node');\n  if (IS_VERCEL) {\n    scope.setTag('vercel', true);\n  }\n\n  scope.addEventProcessor(filterTransactions);\n\n  if (process.env.NODE_ENV === 'development') {\n    scope.addEventProcessor(devErrorSymbolicationEventProcessor);\n  }\n\n  DEBUG_BUILD && logger.log('SDK successfully initialized');\n}\n\nfunction sdkAlreadyInitialized(): boolean {\n  return !!getClient();\n}\n\n// TODO (v8): Remove this\n/**\n * @deprecated This constant will be removed in the next major update.\n */\nconst deprecatedIsBuild = (): boolean => isBuild();\n// eslint-disable-next-line deprecation/deprecation\nexport { deprecatedIsBuild as isBuild };\n\nexport * from '../common';\n\nexport {\n  // eslint-disable-next-line deprecation/deprecation\n  withSentry,\n  // eslint-disable-next-line deprecation/deprecation\n  withSentryAPI,\n  wrapApiHandlerWithSentry,\n} from '../common/wrapApiHandlerWithSentry';\n"],"names":["OriginalIntegrations","nodeInit"],"mappings":"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"}