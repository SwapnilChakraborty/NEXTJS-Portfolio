{"version":3,"file":"appRouterRoutingInstrumentation.js","sources":["../../../../src/client/routing/appRouterRoutingInstrumentation.ts"],"sourcesContent":["import { WINDOW } from '@sentry/react';\nimport type { Primitive, Span, StartSpanOptions, Transaction, TransactionContext } from '@sentry/types';\nimport { addFetchInstrumentationHandler, browserPerformanceTimeOrigin } from '@sentry/utils';\n\ntype StartTransactionCb = (context: TransactionContext) => Transaction | undefined;\ntype StartSpanCb = (context: StartSpanOptions) => void;\n\nconst DEFAULT_TAGS = {\n  'routing.instrumentation': 'next-app-router',\n} as const;\n\n/**\n * Instruments the Next.js Client App Router.\n */\n// TODO(v8): Clean this function up by splitting into pageload and navigation instrumentation respectively. Also remove startTransactionCb in the process.\nexport function appRouterInstrumentation(\n  startTransactionCb: StartTransactionCb,\n  startTransactionOnPageLoad: boolean = true,\n  startTransactionOnLocationChange: boolean = true,\n  startPageloadSpanCallback: StartSpanCb,\n  startNavigationSpanCallback: StartSpanCb,\n): void {\n  // We keep track of the active transaction so we can finish it when we start a navigation transaction.\n  let activeTransaction: Span | undefined = undefined;\n\n  // We keep track of the previous location name so we can set the `from` field on navigation transactions.\n  // This is either a route or a pathname.\n  let prevLocationName = WINDOW.location.pathname;\n\n  if (startTransactionOnPageLoad) {\n    const transactionContext = {\n      name: prevLocationName,\n      op: 'pageload',\n      origin: 'auto.pageload.nextjs.app_router_instrumentation',\n      tags: DEFAULT_TAGS,\n      // pageload should always start at timeOrigin (and needs to be in s, not ms)\n      startTimestamp: browserPerformanceTimeOrigin ? browserPerformanceTimeOrigin / 1000 : undefined,\n      metadata: { source: 'url' },\n    } as const;\n    activeTransaction = startTransactionCb(transactionContext);\n    startPageloadSpanCallback(transactionContext);\n  }\n\n  if (startTransactionOnLocationChange) {\n    addFetchInstrumentationHandler(handlerData => {\n      // The instrumentation handler is invoked twice - once for starting a request and once when the req finishes\n      // We can use the existence of the end-timestamp to filter out \"finishing\"-events.\n      if (handlerData.endTimestamp !== undefined) {\n        return;\n      }\n\n      // Only GET requests can be navigating RSC requests\n      if (handlerData.fetchData.method !== 'GET') {\n        return;\n      }\n\n      const parsedNavigatingRscFetchArgs = parseNavigatingRscFetchArgs(handlerData.args);\n\n      if (parsedNavigatingRscFetchArgs === null) {\n        return;\n      }\n\n      const transactionName = parsedNavigatingRscFetchArgs.targetPathname;\n      const tags: Record<string, Primitive> = {\n        ...DEFAULT_TAGS,\n        from: prevLocationName,\n      };\n\n      prevLocationName = transactionName;\n\n      if (activeTransaction) {\n        activeTransaction.end();\n      }\n\n      const transactionContext = {\n        name: transactionName,\n        op: 'navigation',\n        origin: 'auto.navigation.nextjs.app_router_instrumentation',\n        tags,\n        metadata: { source: 'url' },\n      } as const;\n\n      startTransactionCb(transactionContext);\n      startNavigationSpanCallback(transactionContext);\n    });\n  }\n}\n\nfunction parseNavigatingRscFetchArgs(fetchArgs: unknown[]): null | {\n  targetPathname: string;\n} {\n  // Make sure the first arg is a URL object\n  if (!fetchArgs[0] || typeof fetchArgs[0] !== 'object' || (fetchArgs[0] as URL).searchParams === undefined) {\n    return null;\n  }\n\n  // Make sure the second argument is some kind of fetch config obj that contains headers\n  if (!fetchArgs[1] || typeof fetchArgs[1] !== 'object' || !('headers' in fetchArgs[1])) {\n    return null;\n  }\n\n  try {\n    const url = fetchArgs[0] as URL;\n    const headers = fetchArgs[1].headers as Record<string, string>;\n\n    // Not an RSC request\n    if (headers['RSC'] !== '1') {\n      return null;\n    }\n\n    // Prefetch requests are not navigating RSC requests\n    if (headers['Next-Router-Prefetch'] === '1') {\n      return null;\n    }\n\n    return {\n      targetPathname: url.pathname,\n    };\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":"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"}